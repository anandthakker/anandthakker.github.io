<!DOCTYPE html>
<html lang="" class="no-js">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Interative &amp; Data-driven Styles with Mapbox GL JS - Interative &amp; Data-driven Styles with Mapbox GL JS - Anand Thakker
    </title>
    <meta name="description" content="Personal site of Anand Thakker">
    <link rel="stylesheet" type="text/css" href="/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Playfair+Display|Playfair+Display+SC|Open+Sans|Gudea:400,700,400italic">
    <meta name="google-site-verification" content="EzZE5XKp-gONi3TwRsa5riwb2NBjkOCFb6LGy3PNq7g">
    <script src="/js/vendor/modernizr.custom.js"></script>
    <link rel="stylesheet" type="text/css" href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.11.0/mapbox-gl.css">
  </head>
  <body class="article-detail">
    <!--[if lt IE 10]>
    <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <div class="container">
      <header class="site-header">
        <h1><span class="name">Anand Thakker</span><span class="email"> </span><span class="protocol">http://</span>anand.codes</h1>
        <nav role="navigation">
          <ul>
            <li><a href="/">home</a></li>
            <li><a href="/projects">projects</a></li>
            <li><a href="/notes">notes</a></li>
            <li><a href="/resume">resume</a></li>
          </ul>
        </nav>
      </header>
      <main class="main">
        <article class="article">
          <header><span class="date">22 September 2015</span>
            <h2>Interative &amp; Data-driven Styles with Mapbox GL JS</h2>
          </header>
          <section class="content"><p><strong>tl;dr:</strong> Mapbox <span class="caps">GL</span> JS feels like the future of web maps, promising
data-driven styles (e.g. a color scale) and interaction-driven styles (e.g.
<code>:hover</code>).  They’re still in the works as first-class features of the <span class="caps">API</span>, but
it’s possible–through some mild workarounds–to make them work today.
Examples with code <a href="/2015/09/21/interative-data-driven-styles-with-mapbox-gl-js/#hover">below</a>.</p>
<h2 id="interactivity-vs-rich-visual-style">Interactivity vs Rich Visual&nbsp;Style</h2>
<p><a href="https://www.mapbox.com/mapbox-gl-js/api/">Mapbox <span class="caps">GL</span> JS</a> is awesome.  Until it came along, there often seemed to be
deep, difficult tradeoffs in web maps between interactivity and rich visual
styling.  For interactivity, you could send you geographic data to the browser
as GeoJSON (or something) and render it there, but that meant there were real
limits to how much you could feasibly visualize on your map.  Alternatively, you
could use a tools like <a href="https://www.mapbox.com/mapbox-studio-classic/#darwin">Mapbox Studio
Classic</a> to render rich,
beautiful, data-driven maps that could be served to the browser efficiently as
image tiles, but then you don’t have the underlying data, and thus you can’t
have&nbsp;interactivity.</p>
<p>Libraries like <a href="http://leafletjs.com/">Leaflet</a> (and <a href="https://www.mapbox.com/mapbox.js/api/v2.2.2/">Mapbox.js</a>, and many
others) do a pretty great job at helping do both of these at once, but it’s a
bit of a weird dance decomposing a map into some layers that are static and
richly visualized, and others that are interactive but leaner,&nbsp;data-wise.</p>
<h2 id="have-eat-cake">Have <span class="amp">&amp;</span> Eat&nbsp;Cake</h2>
<p>With Mapbox <span class="caps">GL</span>, instead of having to juggle these two approaches, we get the
best of both worlds.  The server side serves up the geo data using <a href="https://www.mapbox.com/developers/vector-tiles/">vector
tiles</a>, and the client side styles and renders it. It’s elegant and
effective. (Read more here: <a href="https://www.mapbox.com/blog/whats-in-a-mapbox-studio-style/">What’s in a Mapbox Studio Style</a>.)</p>
<p>Mapbox <span class="caps">GL</span> JS is easily badass enough already to be used for many production
applications–e.g. at <a href="https://developmentseed.org">Dev Seed</a> we used it to make
an interactive visualization of electricity use in 600,000 villages across India
every month for the past 20 years. It’s pretty easy to get started with it, too:
it’s already documented with <a href="https://www.mapbox.com/mapbox-gl-js/examples/">good examples of basic usage</a>, and nice, complete <a href="https://www.mapbox.com/mapbox-gl-js/api/"><span class="caps">API</span> documentation</a>.</p>
<p>But there are a couple of key pieces that are still in the works: namely,
<a href="https://github.com/mapbox/mapbox-gl-js/milestones/Data%20Driven%20Styles"><strong>data-driven styles</strong></a> and <a href="https://github.com/mapbox/mapbox-gl-js/issues/200"><strong>interaction-driven styles</strong></a>.  In the near
future, it looks like both of these will be made first-class features of the
<span class="caps">API</span>.  When that happens, it will be possible to design these things directly
from the new hotness that is <a href="https://www.mapbox.com/studio/">Mapbox Studio</a> (which is in private beta at the
time I’m writing this). In the meantime, though, it’s actually not too hard to
do it now. I’ll show how below, but if you’ve never touched Mapbox <span class="caps">GL</span> JS,
it’s probably worth looking through the basic examples&nbsp;first.</p>
<h2 id="layers-and-filters">Layers and&nbsp;Filters</h2>
<p>The key to doing both of these is the <a href="https://www.mapbox.com/mapbox-gl-style-spec/#filter"><code>filter</code></a> feature of Mapbox <span class="caps">GL</span>
styles.  Each layer in a Mapbox GL style pulls features from a data source and
paints them according to style rules (like <code>fill-opacity</code>, or <code>text-size</code>).
Until data-driven styling is implemented, the values for these style rules have
to be constant for each layer.  But layers also have a <code>filter</code> property that
lets us set up rules for <em>which</em> features they actually pull from the source,
and these rules are data driven: they’re basically simple functions of the
features’&nbsp;properties.</p>
<h2 id="hover">Hover</h2>
<div style="width: 100%; height: 400px; position: relative;">
<div id="hover-map" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%"></div>
</div>

<p>Here’s a simple example of a ‘hover’ style.  It works by making two copies of
the layer of interest: one with the normal style, and one with the special hover
style.  Then, on <code>mousemove</code>, we use the <code>featuresAt</code> method to see what
feature(s) we’re hovering over, and use that information to update the hover
layer’s <code>filter</code> property to only select those features.  In&nbsp;code:</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> hoverStyle = {
  version: <span class="number">8</span>,
  name: <span class="string">'Basic'</span>,
  sources: {
    <span class="string">'states'</span>: {
      <span class="string">'type'</span>: <span class="string">'vector'</span>,
      <span class="string">'url'</span>: <span class="string">'mapbox://devseed.6qvmq8pf'</span>
    }
  },
  sprite: <span class="string">''</span>,
  glyphs: <span class="string">''</span>,
  layers: [{
    id: <span class="string">'background'</span>,
    type: <span class="string">'background'</span>,
    paint: { <span class="string">'background-color'</span>: <span class="string">'#5b6b6b'</span> }
  }, { <span class="comment">// this is our normal layer to draw the states</span>
    id: <span class="string">'states'</span>,
    type: <span class="string">'line'</span>,
    source: <span class="string">'states'</span>,
    <span class="string">'source-layer'</span>: <span class="string">'<span class="caps">US</span>-States'</span>,
    interactive: <span class="literal">true</span>,
    paint: { <span class="string">'line-color'</span>: <span class="string">'#314040'</span> }
  }, { <span class="comment">// this layer will only styled the state that's currently hovered</span>
    id: <span class="string">'states-hover'</span>,
    type: <span class="string">'fill'</span>,
    source: <span class="string">'states'</span>,
    <span class="string">'source-layer'</span>: <span class="string">'<span class="caps">US</span>-States'</span>,
    paint: { <span class="string">'fill-color'</span>: <span class="string">'#0b1a1a'</span> },
    filter: [ <span class="string">'all'</span>,
      [ <span class="string">'=='</span>, <span class="string">'<span class="caps">GEOID10</span>'</span>, <span class="string">'<span class="caps">NONE</span>'</span> ] <span class="comment">// start with a filter that doesn't select anything</span>
    ]
  }]
}

<span class="keyword">var</span> hovermap = <span class="keyword">new</span> mapboxgl.Map({
  container: <span class="string">'hover-map'</span>,
  style: hoverStyle,
  center: [-<span class="number">74.50</span>, <span class="number">40</span>],
  zoom: <span class="number">4</span>,
  minZoom: <span class="number">3</span>,
  maxZoom: <span class="number">8</span>
})

hovermap.on(<span class="string">'mousemove'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>{
  <span class="comment">// query the map for the under the mouse</span>
  hovermap.featuresAt(e.point, { radius: <span class="number">5</span>, includeGeometry: <span class="literal">true</span> }, <span class="function"><span class="keyword">function</span> (<span class="params">err, features</span>) </span>{
    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err
    <span class="built_in">console</span>.log(e.point, features)
    <span class="keyword">var</span> ids = features.map(<span class="function"><span class="keyword">function</span> (<span class="params">feat</span>) </span>{ <span class="keyword">return</span> feat.properties.<span class="caps">GEOID10</span> })

    <span class="comment">// set the filter on the hover style layer to only select the features</span>
    <span class="comment">// currently under the mouse</span>
    hovermap.setFilter(<span class="string">'states-hover'</span>, [ <span class="string">'all'</span>,
      [ <span class="string">'in'</span>, <span class="string">'<span class="caps">GEOID10</span>'</span> ].concat(ids)
    ])
  })
})
</code></pre>
<p><a href="http://bl.ocks.org/anandthakker/69afa4bfb0c4f5778785">Full code&nbsp;here.</a></p>
<h2 id="data-driven-color-scale">Data-driven color&nbsp;scale</h2>
<div style="width: 100%; height: 400px; position: relative;">
<div id="color-map" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%"></div>
</div>

<p>Here’s an example of making a color scale based on
population density (stored as the <code>pop_density</code> property on each feature).
Similar to the hover, it works by creating multiple layers–in this case, one
for <em>each level</em> of the color scale.  Then, for each level, we set the filter to
select only the features that have a <code>pop_density</code> value in the relevant range
for that level.  In&nbsp;code:</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> chorostyle = {
  version: <span class="number">8</span>,
  name: <span class="string">'Basic'</span>,
  sources: {
    <span class="string">'us-counties'</span>: {
      <span class="string">'type'</span>: <span class="string">'vector'</span>,
      <span class="string">'url'</span>: <span class="string">'mapbox://devseed.us-counties'</span>
    }
  },
  sprite: <span class="string">''</span>,
  glyphs: <span class="string">''</span>,
  layers: [{
    id: <span class="string">'background'</span>,
    type: <span class="string">'background'</span>,
    paint: { <span class="string">'background-color'</span>: <span class="string">'#000'</span> }
  }]
}

<span class="comment">// the logarithmic scale we'll use</span>
<span class="keyword">var</span> breaks = [<span class="number">0</span>, <span class="number">4</span>, <span class="number">16</span>, <span class="number">64</span>, <span class="number">256</span>, <span class="number">1024</span>, <span class="number">4096</span>, <span class="number">16384</span>, <span class="number">65536</span>]

<span class="comment">// for each level, we set the filter to choose features with population</span>
<span class="comment">// density values between two consecutive values from the scale</span>
<span class="keyword">for</span> (<span class="keyword">var</span> p = <span class="number">0</span>; p &lt; breaks.length; p++) {
  <span class="keyword">var</span> filters
  <span class="keyword">if</span> (p &lt; breaks.length - <span class="number">1</span>) {
    filters = [ <span class="string">'all'</span>,
      [ <span class="string">'&gt;='</span>, <span class="string">'pop_density'</span>, breaks[p] ],
      [ <span class="string">'&lt;'</span>, <span class="string">'pop_density'</span>, breaks[p + <span class="number">1</span>] ]
    ]
  } <span class="keyword">else</span> {
    filters = [ <span class="string">'all'</span>,
      [ <span class="string">'&gt;='</span>, <span class="string">'pop_density'</span>, breaks[p] ]
    ]
  }
  choroStyle.layers.push({
    id: <span class="string">'counties-pop-'</span> + p,
    type: <span class="string">'fill'</span>,
    source: <span class="string">'us-counties'</span>,
    <span class="string">'source-layer'</span>: <span class="string">'counties'</span>,
    paint: {
      <span class="string">'fill-color'</span>: <span class="string">'#5b6b6b'</span>,
      <span class="comment">// set the opacity based on the level</span>
      <span class="string">'fill-opacity'</span>: (p + <span class="number">1</span>) / breaks.length
    },
    filter: filters
  })
}

<span class="keyword">var</span> choro = <span class="keyword">new</span> mapboxgl.Map({
  container: <span class="string">'color-map'</span>,
  style: choroStyle,
  center: [-<span class="number">74.50</span>, <span class="number">40</span>],
  zoom: <span class="number">3</span>
})
</code></pre>
<p><a href="http://bl.ocks.org/anandthakker/52d26ae7b71b7e23c279">Full code&nbsp;here.</a></p>
</section>
        </article>
      </main>
    </div>
    <footer class="container">
      <div class="pagenav"><a href="/notes/">« Full blog</a></div>
      <section class="copy">
        <p>&copy; 2015 Anand Thakker</p>
        <nav>
          <ul>
            <li><a href="/about">about</a></li>
            <li><a href="https://twitter.com/anandthakker">twitter</a></li>
            <li><a href="https://github.com/anandthakker">github</a></li>
          </ul>
        </nav>
      </section>
      <section class="poweredby">
        <p>Powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a><br><a href="https://github.com/anandthakker/anandthakker.net">Site Source</a><br><a href="/site.json">All Content (JSON)</a></p>
      </section>
    </footer>
    <script src="/js/main.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.11.0/mapbox-gl.js"></script>
    <script src="/notes/mapbox-gl-data-driven/script.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-51586528-1', 'anandthakker.net');
      ga('send', 'pageview');
    </script>
  </body>
</html>